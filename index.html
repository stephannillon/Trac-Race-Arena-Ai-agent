<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TNK Race Arena ‚Äî Powered by Intercom P2P</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Rajdhani:wght@300;500;700&display=swap');

  :root {
    --neon-green: #00ff88;
    --neon-yellow: #ffe600;
    --neon-red: #ff2244;
    --neon-blue: #00cfff;
    --dark: #050810;
    --dark2: #0a1020;
    --dark3: #0f1a30;
    --panel: rgba(0,255,136,0.05);
    --border: rgba(0,255,136,0.2);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--dark);
    color: #e0ffe8;
    font-family: 'Rajdhani', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,255,136,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,136,0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(0,255,136,0.08) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  /* HEADER */
  header {
    text-align: center;
    padding: 30px 0 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 30px;
    position: relative;
  }

  .logo-tag {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--neon-green);
    letter-spacing: 4px;
    text-transform: uppercase;
    opacity: 0.7;
    margin-bottom: 8px;
  }

  h1 {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(32px, 6vw, 64px);
    font-weight: 900;
    letter-spacing: -1px;
    line-height: 1;
    background: linear-gradient(135deg, var(--neon-green) 0%, var(--neon-yellow) 50%, var(--neon-green) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: none;
    margin-bottom: 8px;
    animation: pulse-text 3s ease-in-out infinite;
  }

  @keyframes pulse-text {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.3); }
  }

  .subtitle {
    font-size: 14px;
    color: rgba(0,255,136,0.5);
    font-family: 'Share Tech Mono', monospace;
    letter-spacing: 2px;
  }

  .network-status {
    position: absolute;
    top: 30px;
    right: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--neon-green);
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--neon-green);
    box-shadow: 0 0 8px var(--neon-green);
    animation: blink 1.5s ease-in-out infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* MAIN LAYOUT */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 20px;
    margin-bottom: 20px;
  }

  @media (max-width: 900px) {
    .main-grid { grid-template-columns: 1fr; }
  }

  /* PANEL */
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }

  .panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--neon-green), transparent);
  }

  .panel-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 11px;
    letter-spacing: 3px;
    color: var(--neon-green);
    text-transform: uppercase;
    margin-bottom: 16px;
    opacity: 0.8;
  }

  /* RACE TRACK */
  #raceCanvas {
    width: 100%;
    height: 300px;
    border-radius: 4px;
    display: block;
    background: #060e1a;
    border: 1px solid rgba(0,255,136,0.15);
  }

  /* RACE CONTROLS */
  .race-controls {
    display: flex;
    gap: 10px;
    margin-top: 16px;
    flex-wrap: wrap;
  }

  .btn {
    font-family: 'Orbitron', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 2px;
    padding: 12px 24px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .btn-primary {
    background: var(--neon-green);
    color: var(--dark);
    box-shadow: 0 0 20px rgba(0,255,136,0.4);
  }

  .btn-primary:hover {
    box-shadow: 0 0 30px rgba(0,255,136,0.7);
    transform: translateY(-2px);
  }

  .btn-primary:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
  }

  .btn-secondary {
    background: transparent;
    color: var(--neon-green);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    border-color: var(--neon-green);
    box-shadow: 0 0 15px rgba(0,255,136,0.2);
  }

  /* LEADERBOARD */
  .leaderboard-list {
    list-style: none;
  }

  .lb-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(0,255,136,0.08);
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    transition: all 0.3s;
  }

  .lb-item:last-child { border-bottom: none; }

  .lb-rank {
    font-family: 'Orbitron', sans-serif;
    font-size: 11px;
    font-weight: 900;
    width: 28px;
    text-align: center;
  }

  .rank-1 { color: var(--neon-yellow); text-shadow: 0 0 8px var(--neon-yellow); }
  .rank-2 { color: #c0c0c0; }
  .rank-3 { color: #cd7f32; }

  .lb-car-dot {
    width: 12px;
    height: 12px;
    border-radius: 2px;
  }

  .lb-name { flex: 1; color: rgba(224,255,232,0.8); }
  .lb-time {
    color: var(--neon-green);
    font-size: 12px;
  }

  .lb-tnk {
    color: var(--neon-yellow);
    font-size: 11px;
    font-weight: bold;
  }

  /* AI AGENT PANEL */
  .agent-log {
    height: 200px;
    overflow-y: auto;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    line-height: 1.8;
    color: rgba(0,255,136,0.7);
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(0,255,136,0.1);
    border-radius: 4px;
    padding: 12px;
    scroll-behavior: smooth;
  }

  .agent-log::-webkit-scrollbar { width: 4px; }
  .agent-log::-webkit-scrollbar-track { background: transparent; }
  .agent-log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .log-line { margin-bottom: 2px; }
  .log-line .time { color: rgba(0,255,136,0.35); margin-right: 8px; }
  .log-line .agent-tag { color: var(--neon-blue); margin-right: 6px; font-weight: bold; }
  .log-info { color: rgba(224,255,232,0.6); }
  .log-warn { color: var(--neon-yellow); }
  .log-good { color: var(--neon-green); font-weight: bold; }

  /* STATS ROW */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  @media (max-width: 600px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
  }

  .stat-card {
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px 12px;
    text-align: center;
  }

  .stat-value {
    font-family: 'Orbitron', sans-serif;
    font-size: 22px;
    font-weight: 900;
    color: var(--neon-green);
    display: block;
    text-shadow: 0 0 10px rgba(0,255,136,0.5);
  }

  .stat-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: rgba(0,255,136,0.4);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-top: 4px;
    display: block;
  }

  /* RACE RESULT MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.active {
    opacity: 1;
    pointer-events: all;
  }

  .modal {
    background: var(--dark2);
    border: 1px solid var(--neon-green);
    border-radius: 6px;
    padding: 40px;
    text-align: center;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 0 60px rgba(0,255,136,0.3);
    transform: scale(0.9);
    transition: transform 0.3s;
  }

  .modal-overlay.active .modal { transform: scale(1); }

  .modal-trophy {
    font-size: 60px;
    margin-bottom: 16px;
    display: block;
    animation: float 2s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  .modal-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 24px;
    font-weight: 900;
    color: var(--neon-yellow);
    margin-bottom: 8px;
    text-shadow: 0 0 20px rgba(255,230,0,0.5);
  }

  .modal-reward {
    font-family: 'Orbitron', sans-serif;
    font-size: 36px;
    font-weight: 900;
    color: var(--neon-green);
    margin: 16px 0;
    text-shadow: 0 0 20px rgba(0,255,136,0.6);
  }

  .modal-sub {
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: rgba(224,255,232,0.5);
    letter-spacing: 1px;
    margin-bottom: 24px;
  }

  /* INTERCOM INFO */
  .intercom-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(0,207,255,0.08);
    border: 1px solid rgba(0,207,255,0.25);
    border-radius: 3px;
    padding: 6px 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--neon-blue);
    margin-bottom: 20px;
  }

  /* Car selection */
  .car-select {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .car-opt {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: rgba(224,255,232,0.5);
    background: rgba(0,0,0,0.3);
  }

  .car-opt.selected {
    border-color: var(--neon-green);
    background: rgba(0,255,136,0.08);
    color: var(--neon-green);
    box-shadow: 0 0 15px rgba(0,255,136,0.15);
  }

  .car-icon { font-size: 24px; }

  /* Speedometer */
  .speed-meter {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 12px;
    padding: 10px 14px;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(0,255,136,0.1);
    border-radius: 4px;
  }

  .speed-bar-track {
    flex: 1;
    height: 6px;
    background: rgba(0,255,136,0.1);
    border-radius: 3px;
    overflow: hidden;
  }

  .speed-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--neon-green), var(--neon-yellow));
    border-radius: 3px;
    width: 0%;
    transition: width 0.1s;
    box-shadow: 0 0 6px rgba(0,255,136,0.5);
  }

  .speed-val {
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    color: var(--neon-green);
    min-width: 55px;
    text-align: right;
  }

  footer {
    text-align: center;
    padding: 30px 0 20px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: rgba(0,255,136,0.3);
    letter-spacing: 1px;
    border-top: 1px solid var(--border);
    margin-top: 20px;
  }

  footer a { color: var(--neon-blue); text-decoration: none; }

  /* lap progress */
  .lap-bars {
    display: flex;
    gap: 4px;
    margin: 12px 0;
  }

  .lap-bar {
    flex: 1;
    height: 4px;
    background: rgba(0,255,136,0.1);
    border-radius: 2px;
    transition: background 0.4s;
  }

  .lap-bar.done { background: var(--neon-green); box-shadow: 0 0 6px rgba(0,255,136,0.5); }
  .lap-bar.active { background: var(--neon-yellow); box-shadow: 0 0 6px rgba(255,230,0,0.5); animation: pulse-bar 0.5s ease-in-out infinite alternate; }

  @keyframes pulse-bar {
    from { opacity: 0.6; }
    to { opacity: 1; }
  }
</style>
</head>
<body>

<div class="container">

  <header>
    <div class="logo-tag">‚ö° Intercom P2P Network // Trac Systems</div>
    <h1>TNK RACE ARENA</h1>
    <p class="subtitle">// AI-POWERED RACING ¬∑ EARN TNK REWARDS ¬∑ P2P VERIFIED</p>
    <div class="network-status">
      <div class="dot"></div>
      INTERCOM NODE ACTIVE
    </div>
  </header>

  <!-- STATS -->
  <div class="stats-row">
    <div class="stat-card">
      <span class="stat-value" id="totalRaces">0</span>
      <span class="stat-label">Races Run</span>
    </div>
    <div class="stat-card">
      <span class="stat-value" id="totalWins">0</span>
      <span class="stat-label">Wins</span>
    </div>
    <div class="stat-card">
      <span class="stat-value" id="totalTNK">0</span>
      <span class="stat-label">TNK Earned</span>
    </div>
    <div class="stat-card">
      <span class="stat-value" id="bestTime">--</span>
      <span class="stat-label">Best Lap</span>
    </div>
  </div>

  <div class="intercom-badge">
    <span>üîó</span>
    <span>INTERCOM SIDECHANNEL: race.arena.p2p // PEERS: <span id="peerCount">0</span></span>
  </div>

  <div class="main-grid">
    <!-- LEFT: RACE -->
    <div>
      <div class="panel" style="margin-bottom: 20px;">
        <div class="panel-title">// RACE CONFIGURATION</div>

        <div style="margin-bottom: 12px; font-size: 13px; color: rgba(224,255,232,0.6);">SELECT YOUR RACER:</div>
        <div class="car-select" id="carSelect">
          <div class="car-opt selected" data-car="0" data-color="#00ff88" data-speed="9">
            <span class="car-icon">üöó</span>
            <span>PHANTOM</span>
            <span style="color:var(--neon-green)">SPD 9</span>
          </div>
          <div class="car-opt" data-car="1" data-color="#ff2244" data-speed="8">
            <span class="car-icon">üèéÔ∏è</span>
            <span>BLAZE</span>
            <span style="color:rgba(255,34,68,0.8)">SPD 8</span>
          </div>
          <div class="car-opt" data-car="2" data-color="#ffe600" data-speed="10">
            <span class="car-icon">üöÄ</span>
            <span>HYPER-X</span>
            <span style="color:var(--neon-yellow)">SPD 10</span>
          </div>
          <div class="car-opt" data-car="3" data-color="#00cfff" data-speed="7">
            <span class="car-icon">üõ∏</span>
            <span>SPECTER</span>
            <span style="color:var(--neon-blue)">SPD 7</span>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">// RACE TRACK ‚Äî 3 LAPS</div>

        <div class="lap-bars" id="lapBars">
          <div class="lap-bar" id="lap0"></div>
          <div class="lap-bar" id="lap1"></div>
          <div class="lap-bar" id="lap2"></div>
        </div>

        <canvas id="raceCanvas"></canvas>

        <div class="speed-meter">
          <span style="font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(0,255,136,0.4);letter-spacing:1px">SPEED</span>
          <div class="speed-bar-track">
            <div class="speed-bar-fill" id="speedBar"></div>
          </div>
          <span class="speed-val" id="speedVal">0 km/h</span>
        </div>

        <div class="race-controls">
          <button class="btn btn-primary" id="startBtn" onclick="startRace()">‚ñ∂ START RACE</button>
          <button class="btn btn-secondary" onclick="resetRace()">‚Ü∫ RESET</button>
          <span style="flex:1"></span>
          <span id="raceTimer" style="font-family:'Orbitron',monospace;font-size:20px;color:var(--neon-yellow);align-self:center;min-width:80px;text-align:right">00:00</span>
        </div>
      </div>
    </div>

    <!-- RIGHT: AI AGENT + LEADERBOARD -->
    <div>
      <!-- AI Agent -->
      <div class="panel" style="margin-bottom: 20px;">
        <div class="panel-title">// AI RACE AGENT</div>
        <div class="agent-log" id="agentLog">
          <div class="log-line"><span class="time">[BOOT]</span><span class="agent-tag">[AGENT]</span><span class="log-info">TNK Race Agent v1.0 initializing...</span></div>
        </div>
        <div style="margin-top: 10px; display:flex; gap:8px;">
          <button class="btn btn-secondary" style="font-size:10px;padding:8px 12px;" onclick="agentAnalyze()">‚ö° AI ANALYZE</button>
          <button class="btn btn-secondary" style="font-size:10px;padding:8px 12px;" onclick="agentPredict()">üîÆ PREDICT</button>
        </div>
      </div>

      <!-- Leaderboard -->
      <div class="panel">
        <div class="panel-title">// GLOBAL LEADERBOARD</div>
        <ul class="leaderboard-list" id="leaderboard">
          <li class="lb-item">
            <span class="lb-rank rank-1">01</span>
            <div class="lb-car-dot" style="background:#ffe600"></div>
            <span class="lb-name">HYPERVOLT_X</span>
            <span class="lb-time">28.4s</span>
            <span class="lb-tnk">+500 TNK</span>
          </li>
          <li class="lb-item">
            <span class="lb-rank rank-2">02</span>
            <div class="lb-car-dot" style="background:#00ff88"></div>
            <span class="lb-name">P2P_RACER</span>
            <span class="lb-time">29.1s</span>
            <span class="lb-tnk">+300 TNK</span>
          </li>
          <li class="lb-item">
            <span class="lb-rank rank-3">03</span>
            <div class="lb-car-dot" style="background:#00cfff"></div>
            <span class="lb-name">TRAC_AGENT7</span>
            <span class="lb-time">30.8s</span>
            <span class="lb-tnk">+150 TNK</span>
          </li>
          <li class="lb-item">
            <span class="lb-rank" style="color:rgba(224,255,232,0.4)">04</span>
            <div class="lb-car-dot" style="background:#ff2244"></div>
            <span class="lb-name">BLAZE_NODE</span>
            <span class="lb-time">31.2s</span>
            <span class="lb-tnk">+50 TNK</span>
          </li>
          <li class="lb-item">
            <span class="lb-rank" style="color:rgba(224,255,232,0.4)">05</span>
            <div class="lb-car-dot" style="background:#9b59b6"></div>
            <span class="lb-name">INTERCOM_V1</span>
            <span class="lb-time">32.7s</span>
            <span class="lb-tnk">+50 TNK</span>
          </li>
        </ul>
        <div style="margin-top:12px;font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(0,255,136,0.3);text-align:center;letter-spacing:1px">
          SCORES REPLICATED VIA INTERCOM P2P
        </div>
      </div>
    </div>
  </div>

</div>

<!-- WIN MODAL -->
<div class="modal-overlay" id="winModal">
  <div class="modal">
    <span class="modal-trophy" id="modalTrophy">üèÜ</span>
    <div class="modal-title" id="modalTitle">RACE COMPLETE!</div>
    <div class="modal-reward" id="modalTNK">+500 TNK</div>
    <div class="modal-sub" id="modalSub">VERIFIED VIA INTERCOM P2P SIDECHANNEL</div>
    <div style="margin-bottom:20px;font-family:'Share Tech Mono',monospace;font-size:12px;color:rgba(224,255,232,0.6)">
      Final Time: <span id="modalTime" style="color:var(--neon-green)">00:00</span>
    </div>
    <button class="btn btn-primary" onclick="closeModal()" style="width:100%">‚ñ∂ RACE AGAIN</button>
  </div>
</div>

<footer>
  <p>TNK Race Arena ‚Äî Built on <a href="https://github.com/Trac-Systems/intercom" target="_blank">Intercom P2P</a> by Trac Systems</p>
  <p style="margin-top:6px">Fork: <a href="#" target="_blank">github.com/[YOUR_HANDLE]/tnk-race-arena</a> // Trac Address: [YOUR_TRAC_ADDRESS]</p>
</footer>

<script>
// ============================================================
// TNK RACE ARENA ‚Äî CORE ENGINE
// ============================================================

const canvas = document.getElementById('raceCanvas');
const ctx = canvas.getContext('2d');

// Game state
let raceState = {
  running: false,
  startTime: 0,
  elapsed: 0,
  lap: 0,
  playerCar: null,
  aiCars: [],
  totalRaces: 0,
  totalWins: 0,
  totalTNK: 0,
  bestTime: Infinity,
  selectedCar: 0,
  selectedColor: '#00ff88',
  selectedSpeed: 9,
  animFrame: null,
  peers: 0
};

// Car config
const carConfigs = [
  { name: 'PHANTOM', color: '#00ff88', speed: 9, accel: 0.18 },
  { name: 'BLAZE',   color: '#ff2244', speed: 8, accel: 0.22 },
  { name: 'HYPER-X', color: '#ffe600', speed: 10, accel: 0.12 },
  { name: 'SPECTER', color: '#00cfff', speed: 7, accel: 0.25 },
];

const AI_NAMES = ['HYPERVOLT_X', 'P2P_RACER', 'TRAC_AGENT7', 'BLAZE_NODE'];
const AI_COLORS = ['#ffe600', '#ff2244', '#00cfff', '#9b59b6'];

// Track waypoints (oval)
function getTrackPath() {
  const W = canvas.width, H = canvas.height;
  const cx = W/2, cy = H/2;
  const rx = W*0.42, ry = H*0.38;
  return { cx, cy, rx, ry };
}

function trackPos(t, rx, ry, cx, cy) {
  const angle = t * Math.PI * 2 - Math.PI/2;
  return {
    x: cx + Math.cos(angle) * rx,
    y: cy + Math.sin(angle) * ry,
    angle: angle + Math.PI/2
  };
}

// Resize canvas
function resizeCanvas() {
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = Math.min(rect.width - 40, 760);
  canvas.height = 300;
}

resizeCanvas();
window.addEventListener('resize', () => { resizeCanvas(); drawIdle(); });

function drawTrack() {
  const { cx, cy, rx, ry } = getTrackPath();
  const W = canvas.width, H = canvas.height;

  ctx.clearRect(0, 0, W, H);

  // BG
  ctx.fillStyle = '#060e1a';
  ctx.fillRect(0, 0, W, H);

  // Outer track (wide road)
  ctx.save();
  ctx.strokeStyle = '#1a2a3a';
  ctx.lineWidth = 54;
  ctx.beginPath();
  ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI*2);
  ctx.stroke();

  // Road surface
  ctx.strokeStyle = '#0d1e30';
  ctx.lineWidth = 50;
  ctx.beginPath();
  ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI*2);
  ctx.stroke();

  // Lane markers
  ctx.strokeStyle = 'rgba(0,255,136,0.12)';
  ctx.lineWidth = 1;
  ctx.setLineDash([12, 8]);
  ctx.beginPath();
  ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI*2);
  ctx.stroke();
  ctx.setLineDash([]);

  // Edge glow
  ctx.strokeStyle = 'rgba(0,255,136,0.25)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.ellipse(cx, cy, rx+26, ry+26, 0, 0, Math.PI*2);
  ctx.stroke();
  ctx.beginPath();
  ctx.ellipse(cx, cy, rx-26, ry-26, 0, 0, Math.PI*2);
  ctx.stroke();

  // Start/Finish line
  const sfx = cx + rx;
  ctx.strokeStyle = '#ffffff';
  ctx.lineWidth = 3;
  ctx.save();
  ctx.translate(sfx, cy);
  for (let i = -3; i <= 3; i++) {
    ctx.fillStyle = i % 2 === 0 ? '#fff' : '#000';
    ctx.fillRect(-4, i*4, 8, 4);
  }
  ctx.restore();

  ctx.restore();
}

function drawCar(x, y, angle, color, size = 10) {
  ctx.save();
  ctx.translate(x, y);
  ctx.rotate(angle);

  // Glow
  ctx.shadowColor = color;
  ctx.shadowBlur = 12;

  // Car body
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.roundRect(-size*0.4, -size*0.8, size*0.8, size*1.6, 2);
  ctx.fill();

  // Cockpit
  ctx.fillStyle = 'rgba(0,0,0,0.6)';
  ctx.beginPath();
  ctx.roundRect(-size*0.2, -size*0.3, size*0.4, size*0.7, 2);
  ctx.fill();

  // Front lights
  ctx.fillStyle = '#fff';
  ctx.shadowBlur = 6;
  ctx.fillRect(-size*0.35, -size*0.8, size*0.12, size*0.15);
  ctx.fillRect(size*0.23, -size*0.8, size*0.12, size*0.15);

  ctx.restore();
}

function drawIdle() {
  drawTrack();
  const { cx, cy, rx, ry } = getTrackPath();

  // Draw cars at start positions
  carConfigs.forEach((cfg, i) => {
    const t = 0.005 * (i+1);
    const p = trackPos(t, rx, ry, cx, cy);
    drawCar(p.x, p.y + (i-1.5)*8, p.angle, cfg.color, 9);
  });

  // Label
  ctx.font = 'bold 12px "Share Tech Mono"';
  ctx.fillStyle = 'rgba(0,255,136,0.25)';
  ctx.textAlign = 'center';
  ctx.fillText('PRESS START TO RACE', cx, cy + 2);
}

drawIdle();

// === CAR SELECTION ===
document.querySelectorAll('.car-opt').forEach(opt => {
  opt.addEventListener('click', () => {
    if (raceState.running) return;
    document.querySelectorAll('.car-opt').forEach(o => o.classList.remove('selected'));
    opt.classList.add('selected');
    raceState.selectedCar = +opt.dataset.car;
    raceState.selectedColor = opt.dataset.color;
    raceState.selectedSpeed = +opt.dataset.speed;
    drawIdle();
  });
});

// === RACE ===
function startRace() {
  if (raceState.running) return;

  const cfg = carConfigs[raceState.selectedCar];
  const { cx, cy, rx, ry } = getTrackPath();

  raceState.running = true;
  raceState.lap = 0;
  raceState.startTime = performance.now();
  raceState.elapsed = 0;

  document.getElementById('startBtn').disabled = true;

  // Reset lap bars
  for (let i = 0; i < 3; i++) {
    const b = document.getElementById('lap'+i);
    b.className = 'lap-bar';
  }
  document.getElementById('lap0').classList.add('active');

  // Player car
  raceState.playerCar = {
    t: 0,
    speed: 0,
    maxSpeed: 0.0028 + cfg.speed * 0.00025,
    accel: cfg.accel * 0.001,
    color: cfg.color,
    laps: 0,
    name: cfg.name
  };

  // AI cars
  raceState.aiCars = AI_NAMES.slice(0, 3).map((name, i) => ({
    t: -0.015 * (i+1),
    speed: 0,
    maxSpeed: 0.0020 + Math.random() * 0.0012,
    accel: 0.0004 + Math.random() * 0.0003,
    color: AI_COLORS[i],
    laps: 0,
    name,
    erratic: Math.random() * 0.0002
  }));

  agentLog('log-good', '[RACE]', 'üèÅ Race started! AI agents deployed on track.');
  agentLog('log-info', '[AGENT]', `Tracking ${raceState.aiCars.length} opponents via Intercom sidechannel.`);

  // Simulate peers
  raceState.peers = Math.floor(Math.random()*12) + 4;
  document.getElementById('peerCount').textContent = raceState.peers;

  raceLoop();
}

function raceLoop() {
  const { cx, cy, rx, ry } = getTrackPath();
  const car = raceState.playerCar;

  // Update player
  car.speed = Math.min(car.speed + car.accel, car.maxSpeed);
  car.t += car.speed + (Math.random() * 0.0002 - 0.0001);
  if (car.t >= 1) {
    car.t -= 1;
    car.laps++;
    handleLap(car.laps);
  }

  // Update AI
  raceState.aiCars.forEach(ai => {
    ai.speed = Math.min(ai.speed + ai.accel, ai.maxSpeed);
    ai.t += ai.speed + (Math.random() * ai.erratic - ai.erratic/2);
    if (ai.t >= 1) {
      ai.t -= 1;
      ai.laps++;
    }
    if (ai.t < 0) ai.t += 1;
  });

  // Elapsed time
  raceState.elapsed = (performance.now() - raceState.startTime) / 1000;
  const s = Math.floor(raceState.elapsed);
  const ms = Math.floor((raceState.elapsed % 1) * 100);
  document.getElementById('raceTimer').textContent = `${String(s).padStart(2,'0')}:${String(ms).padStart(2,'0')}`;

  // Speed display
  const speedPct = (car.speed / car.maxSpeed) * 100;
  document.getElementById('speedBar').style.width = speedPct + '%';
  const speedKmh = Math.floor(speedPct * 3.2);
  document.getElementById('speedVal').textContent = speedKmh + ' km/h';

  // Draw
  drawTrack();
  raceState.aiCars.forEach(ai => {
    const p = trackPos(ai.t, rx, ry, cx, cy);
    drawCar(p.x, p.y, p.angle, ai.color, 8);
  });
  const pp = trackPos(car.t, rx, ry, cx, cy);
  drawCar(pp.x, pp.y, pp.angle, car.color, 11);

  // Race done?
  if (car.laps >= 3) {
    finishRace();
    return;
  }

  // Check AI win
  const aiWon = raceState.aiCars.find(ai => ai.laps >= 3);
  if (aiWon) {
    finishRace(false);
    return;
  }

  raceState.animFrame = requestAnimationFrame(raceLoop);
}

function handleLap(lapNum) {
  if (lapNum > 3) return;
  agentLog('log-warn', '[LAP]', `Lap ${lapNum}/3 complete. Analyzing trajectory...`);

  // Update lap bars
  for (let i = 0; i < 3; i++) {
    const b = document.getElementById('lap'+i);
    b.className = 'lap-bar';
    if (i < lapNum) b.classList.add('done');
    else if (i === lapNum) b.classList.add('active');
  }
}

function finishRace(playerWon = true) {
  cancelAnimationFrame(raceState.animFrame);
  raceState.running = false;
  document.getElementById('startBtn').disabled = false;

  raceState.totalRaces++;

  const timeStr = document.getElementById('raceTimer').textContent;

  let tnk = 0;
  let trophy = '';
  let title = '';

  if (playerWon) {
    raceState.totalWins++;
    tnk = 500;
    trophy = 'üèÜ';
    title = 'VICTORY!';
    agentLog('log-good', '[WIN]', `üèÜ WINNER! Time: ${timeStr} ‚Äî Broadcasting to Intercom peers.`);
    // Update best time
    if (raceState.elapsed < raceState.bestTime) {
      raceState.bestTime = raceState.elapsed;
      document.getElementById('bestTime').textContent = timeStr;
    }
  } else {
    tnk = 50;
    trophy = 'ü•à';
    title = 'RACE OVER';
    agentLog('log-warn', '[RESULT]', `AI opponent won. You earn +50 TNK for participating.`);
  }

  raceState.totalTNK += tnk;

  // Update stats
  document.getElementById('totalRaces').textContent = raceState.totalRaces;
  document.getElementById('totalWins').textContent = raceState.totalWins;
  document.getElementById('totalTNK').textContent = raceState.totalTNK;

  // Show modal
  document.getElementById('modalTrophy').textContent = trophy;
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalTNK').textContent = `+${tnk} TNK`;
  document.getElementById('modalTime').textContent = timeStr;
  document.getElementById('modalSub').textContent = playerWon
    ? 'RESULT VERIFIED VIA INTERCOM P2P SIDECHANNEL ‚úì'
    : 'BETTER LUCK NEXT RACE ‚Äî TNK PARTICIPATION REWARD';

  setTimeout(() => {
    document.getElementById('winModal').classList.add('active');
  }, 500);

  agentLog('log-info', '[P2P]', `Result broadcast to ${raceState.peers} Intercom peers.`);
}

function resetRace() {
  cancelAnimationFrame(raceState.animFrame);
  raceState.running = false;
  document.getElementById('startBtn').disabled = false;
  document.getElementById('raceTimer').textContent = '00:00';
  document.getElementById('speedBar').style.width = '0%';
  document.getElementById('speedVal').textContent = '0 km/h';
  for (let i = 0; i < 3; i++) {
    document.getElementById('lap'+i).className = 'lap-bar';
  }
  drawIdle();
  agentLog('log-info', '[SYS]', 'Race reset. Ready for new session.');
}

function closeModal() {
  document.getElementById('winModal').classList.remove('active');
  resetRace();
}

// === AI AGENT ===
let logCount = 0;
function agentLog(cls, tag, msg) {
  const log = document.getElementById('agentLog');
  const now = new Date();
  const ts = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
  const line = document.createElement('div');
  line.className = 'log-line';
  line.innerHTML = `<span class="time">[${ts}]</span><span class="agent-tag">${tag}</span><span class="${cls}">${msg}</span>`;
  log.appendChild(line);
  log.scrollTop = log.scrollHeight;
  logCount++;
  if (logCount > 80) {
    log.removeChild(log.firstChild);
  }
}

function agentAnalyze() {
  const analyses = [
    'Analyzing track curvature ‚Äî recommend braking 12% earlier on east bend.',
    'Opponent HYPERVOLT_X running 0.003 t/ms average ‚Äî aggressive pace.',
    'P2P sidechannel latency: 14ms. Race data sync optimal.',
    'Optimal speed window detected: 280-310 km/h on straightaway.',
    'AI telemetry: BLAZE_NODE losing traction ‚Äî exploit gap sector 2.',
    'Trac network confirms 0 penalties on your last run. Clean race.',
    'Sidechannel analysis: 3 peers boosting TNK liquidity pool.',
  ];
  agentLog('log-warn', '[AI]', analyses[Math.floor(Math.random()*analyses.length)]);
}

function agentPredict() {
  const preds = [
    `Win probability: ${Math.floor(Math.random()*40+40)}% ‚Äî favorable conditions.`,
    `Predicted finish time: ${(28 + Math.random()*6).toFixed(1)}s based on track model.`,
    `TNK reward projection: ${Math.floor(Math.random()*400+100)} TNK if podium finish.`,
    `AI opponent modeling: TRAC_AGENT7 slowing due to virtual tire wear.`,
    `Weather sim: DRY. Max performance unlocked for HYPER-X class.`,
    `Intercom P2P: ${Math.floor(Math.random()*8+2)} new peers joined race channel.`,
  ];
  agentLog('log-good', '[PRED]', preds[Math.floor(Math.random()*preds.length)]);
}

// Boot sequence
setTimeout(() => agentLog('log-good', '[NET]', 'Intercom P2P node connected. Discovering peers...'), 600);
setTimeout(() => {
  const p = Math.floor(Math.random()*8+3);
  raceState.peers = p;
  document.getElementById('peerCount').textContent = p;
  agentLog('log-info', '[NET]', `${p} peers found on race.arena.p2p channel.`);
}, 1200);
setTimeout(() => agentLog('log-info', '[SYS]', 'TNK reward contract loaded. Race to earn!'), 2000);
setTimeout(() => agentLog('log-warn', '[AGENT]', 'Standing by. Select car and START RACE to begin.'), 2800);

// Peer heartbeat
setInterval(() => {
  if (!raceState.running) {
    const delta = Math.floor(Math.random()*5)-2;
    raceState.peers = Math.max(1, raceState.peers + delta);
    document.getElementById('peerCount').textContent = raceState.peers;
  }
}, 5000);
</script>
</body>
</html>

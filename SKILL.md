# SKILL: TNK Race Arena Agent

## Overview
This skill enables Intercom AI agents to participate in, orchestrate, and reward TNK Race Arena sessions over Intercom P2P sidechannels.

## Agent Identity
- **Name**: TNK Race Agent
- **Version**: 1.0.0
- **Channel**: `race.arena.p2p`
- **App**: TNK Race Arena (fork of Trac-Systems/intercom)

---

## Capabilities

### 1. Race Session Management
```
TRIGGER: New peer joins race.arena.p2p channel
ACTION:  Broadcast session handshake { type: "race_hello", appId: "tnk-race-arena" }
EXPECT:  Peer responds with { type: "race_ack", peerId, tracAddress }
```

### 2. Live Telemetry Sync
```
EVENT:   position_update
PAYLOAD: { carId, trackPosition (0–1), lapNumber, speedKmh, timestamp }
FREQ:    Every 100ms during active race
PURPOSE: Enables real-time opponent tracking via Intercom sidechannel
```

### 3. Lap Commit (State Layer)
```
EVENT:   lap_complete
PAYLOAD: { raceId, carId, lapNumber, lapTimeMs, tracAddress }
ACTION:  Write to Intercom replicated-state layer as durable record
KEY:     race:{raceId}:lap:{carId}:{lapNumber}
```

### 4. Race Result Broadcast
```
EVENT:   race_result
PAYLOAD: {
  raceId: string,
  winner: { carId, name, timeMs, tracAddress },
  positions: [ { rank, name, timeMs, tnkReward } ],
  timestamp: ISO8601
}
ACTION:  Broadcast to all peers on race.arena.p2p
         Commit final result to state layer: race:{raceId}:result
```

### 5. TNK Reward Logging
```
TRIGGER: race_result committed to state layer
ACTION:  Emit tnk_reward event for each participant
PAYLOAD: { tracAddress, amount, raceId, rank, timestamp }
NOTE:    Actual TNK transfer handled by Trac Network reward contract
```

---

## Agent Behaviors

| Behavior | Description |
|---|---|
| **Auto-join** | Agent joins `race.arena.p2p` on Intercom node start |
| **Peer discovery** | Announces self every 30s to maintain peer list |
| **Telemetry relay** | Relays position_update events to all connected peers |
| **Result arbitration** | First peer to commit race_result becomes round arbiter |
| **Leaderboard sync** | Reads state layer to serve global leaderboard on request |

---

## Intercom Message Schema

```json
{
  "channel": "race.arena.p2p",
  "type": "position_update | lap_complete | race_result | tnk_reward | race_hello | race_ack",
  "appId": "tnk-race-arena",
  "version": "1.0.0",
  "payload": { }
}
```

---

## Example Agent Invocation

```js
// Connect to Intercom and join race channel
const intercom = new Intercom({ node: 'local' });
await intercom.join('race.arena.p2p');

// Listen for race events
intercom.on('race_result', async (msg) => {
  const { winner, positions } = msg.payload;
  console.log(`Race won by ${winner.name} in ${winner.timeMs}ms`);

  // Commit to state layer
  await intercom.state.set(`race:${msg.raceId}:result`, msg.payload);

  // Emit TNK rewards
  for (const p of positions) {
    await intercom.emit('tnk_reward', {
      tracAddress: p.tracAddress,
      amount: p.tnkReward,
      raceId: msg.raceId
    });
  }
});
```

---

## Notes for Agent Developers

- Race positions are normalized floats `[0, 1)` representing track completion per lap
- `raceId` is a UUID generated by the race session initiator
- All timestamps are Unix ms
- Agents should gracefully handle dropped peers mid-race (use last known position)
- The leaderboard state key is `leaderboard:global` — sorted array by best time ascending
